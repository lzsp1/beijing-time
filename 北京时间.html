<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>毫秒级北京时间</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23ffffff' stroke='%23ffd700' stroke-width='8'/%3E%3Ccircle cx='50' cy='50' r='3' fill='%23000000'/%3E%3Cline x1='50' y1='50' x2='50' y2='25' stroke='%23000000' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='50' y1='50' x2='70' y2='60' stroke='%23000000' stroke-width='3' stroke-linecap='round'/%3E%3Cline x1='50' y1='15' x2='50' y2='10' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='85' y1='50' x2='90' y2='50' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='50' y1='85' x2='50' y2='90' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='15' y1='50' x2='10' y2='50' stroke='%23000000' stroke-width='2'/%3E%3Cline x1='25' y1='25' x2='20' y2='20' stroke='%23000000' stroke-width='1.5'/%3E%3Cline x1='75' y1='25' x2='80' y2='20' stroke='%23000000' stroke-width='1.5'/%3E%3Cline x1='75' y1='75' x2='80' y2='80' stroke='%23000000' stroke-width='1.5'/%3E%3Cline x1='25' y1='75' x2='20' y2='80' stroke='%23000000' stroke-width='1.5'/%3E%3C/svg%3E" type="image/svg+xml">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        
        #time-container {
            text-align: center;
        }
        
        #date-info {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        #time {
            font-size: 120px;
            font-weight: bold;
        }
        
        #fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff4500;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        #fullscreen-btn:hover {
            background-color: #ff6347;
        }
        
        #dev-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #333;
            color: #aaa;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        #dev-btn:hover {
            background-color: #444;
            color: #ccc;
        }
        
        /* 版本号样式 */
        #version {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
            font-size: 12px;
            font-family: Arial, sans-serif;
            opacity: 0.8;
        }
        
        /* 刷新次数提示样式 */
        #refresh-counter {
            color: #666;
            font-size: 12px;
            font-family: Arial, sans-serif;
            opacity: 0.7;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: #222;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 400px;
            position: relative;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: #fff;
        }
        
        .modal p {
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .btn-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-green {
            background-color: #4CAF50;
            color: #fff;
        }
        
        .btn-green:hover {
            background-color: #45a049;
        }
        
        .btn-red {
            background-color: #f44336;
            color: #fff;
        }
        
        .btn-red:hover {
            background-color: #da190b;
        }
        
        .btn-blue {
            background-color: #2196F3;
            color: #fff;
        }
        
        .btn-blue:hover {
            background-color: #0b7dda;
        }
        
        .input-container {
            margin: 20px 0;
        }
        
        .input-container input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
            width: 100%;
            max-width: 300px;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: #fff;
        }
        
        .error-msg {
            color: #f44336;
            margin: 10px 0;
        }
        
        .creator-info {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .creator-name {
            font-size: 18px;
            color: #aaa;
        }
        
        /* 检测环境动效样式 */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            color: #ddd;
            margin-bottom: 10px;
        }
        
        .loading-dots {
            display: flex;
            gap: 5px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #4CAF50;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        /* 环境检测通过效果样式 */
        .success-check {
            width: 50px;
            height: 50px;
            background-color: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: successPulse 0.6s ease-in-out;
        }
        
        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .success-check::after {
            content: '✓';
            color: white;
            font-size: 30px;
            font-weight: bold;
        }
        
        .success-text {
            font-size: 18px;
            color: #4CAF50;
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* 环境未通过效果样式 */
        .error-check {
            width: 50px;
            height: 50px;
            background-color: #f44336;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            animation: errorPulse 0.6s ease-in-out;
        }
        
        @keyframes errorPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .error-check::after {
            content: '✗';
            color: white;
            font-size: 30px;
            font-weight: bold;
        }
        
        .error-text {
            font-size: 18px;
            color: #f44336;
            margin-bottom: 10px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 右侧伸缩框样式 */
        .sidebar-container {
            position: absolute;
            top: auto;
            bottom: 80px;
            right: -250px;
            transform: translateY(0);
            width: 280px;
            background-color: rgba(30, 30, 0, 0.95);
            border-radius: 10px 0 0 10px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease;
            z-index: 200;
            clear: both;
            float: none;
        }
        
        .sidebar-container.open {
            right: 0;
        }
        
        .sidebar-toggle {
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: rgba(30, 30, 30, 0.95);
            border: none;
            border-radius: 50%;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .sidebar-toggle:hover {
            background-color: rgba(50, 50, 50, 0.95);
            color: #fff;
        }
        
        .sidebar-content {
            padding: 20px;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .option-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .option-label {
            font-size: 16px;
            color: #ddd;
        }
        
        /* 开关按钮样式 */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <button id="check-update-btn" style="position: absolute; top: 20px; left: 20px; background-color: #333; color: #aaa; border: none; padding: 8px 16px; font-size: 14px; cursor: pointer; border-radius: 5px; transition: all 0.3s;">更新内容</button>
    <button id="fullscreen-btn">全屏</button>
    <button id="settings-btn" style="position: absolute; bottom: 20px; left: 20px; background-color: #333; color: #aaa; border: none; padding: 8px 16px; font-size: 14px; cursor: pointer; border-radius: 5px; transition: all 0.3s;">更多</button>
    
    <div id="time-container">
        <div id="date-info"></div>
        <div id="time"></div>
    </div>
    
    <!-- 倒计时设置区域 -->
    <div id="countdown-setting-area" style="margin-top: 20px; text-align: center; display: none; width: 100%; max-width: 500px;">
        <div style="margin-bottom: 15px; color: #aaa; font-size: 16px;">设置倒计时时长</div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; align-items: center;">
            <input type="number" id="countdown-hours" min="0" max="24" value="0" style="padding: 10px; font-size: 14px; border: 1px solid #555; border-radius: 5px; background-color: rgba(30, 30, 30, 0.8); color: #fff; width: 80px;">
            <span style="color: #aaa; font-size: 18px;">:</span>
            <input type="number" id="countdown-minutes" min="0" max="59" value="5" style="padding: 10px; font-size: 14px; border: 1px solid #555; border-radius: 5px; background-color: rgba(30, 30, 30, 0.8); color: #fff; width: 80px;">
            <span style="color: #aaa; font-size: 18px;">:</span>
            <input type="number" id="countdown-seconds" min="0" max="59" value="0" style="padding: 10px; font-size: 14px; border: 1px solid #555; border-radius: 5px; background-color: rgba(30, 30, 30, 0.8); color: #fff; width: 80px;">
        </div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-green" id="start-countdown-btn" style="padding: 10px 20px; font-size: 14px;">开始倒计时</button>
            <button class="btn btn-yellow" id="pause-countdown-btn" style="padding: 10px 20px; font-size: 14px; background-color: #ffc107; color: #000; transition: background-color 0.3s; display: none;">暂停</button>
            <button class="btn btn-red" id="reset-countdown-btn" style="padding: 10px 20px; font-size: 14px;">重置倒计时</button>
        </div>
    </div>
    
    <!-- 正计时控制区域 -->
    <div id="stopwatch-setting-area" style="margin-top: 20px; text-align: center; display: none; width: 100%; max-width: 500px;">
        <div style="margin-bottom: 15px; color: #aaa; font-size: 16px;">正计时控制</div>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-green" id="start-stopwatch-btn" style="padding: 10px 20px; font-size: 14px;">开始正计时</button>
            <button class="btn btn-yellow" id="pause-stopwatch-btn" style="padding: 10px 20px; font-size: 14px; background-color: #ffc107; color: #000; transition: background-color 0.3s; display: none;">暂停</button>
            <button class="btn btn-red" id="reset-stopwatch-btn" style="padding: 10px 20px; font-size: 14px;">重置正计时</button>
        </div>
    </div>
    
    <!-- 弹窗容器 -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button class="close-btn" id="modal-close">&times;</button>
            <div id="modal-body">
                <!-- 弹窗内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 刷新次数提示 -->
    <div id="refresh-container" style="position: absolute; bottom: 10px; right: 10px; display: flex; flex-direction: row; align-items: center; gap: 10px; width: auto;">
        <div id="refresh-counter" style="display: inline-block;"></div>
        <a href="#" id="reset-refresh" style="display: inline-block; color: #888; font-size: 12px; cursor: pointer; opacity: 0.7; text-decoration: underline;">重置</a>
    </div>
    
    <!-- 设置按钮 -->

    
    <!-- 隐藏的毫秒显示开关，用于JavaScript获取状态 -->
    <div style="display: none;">
        <input type="checkbox" id="ms-toggle" checked>
    </div>
    
    <script>
        // 获取DOM元素
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const checkUpdateBtn = document.getElementById('check-update-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const modal = document.getElementById('modal');
        const modalClose = document.getElementById('modal-close');
        const modalBody = document.getElementById('modal-body');
        const dateInfo = document.getElementById('date-info');
        const timeElement = document.getElementById('time');
        const refreshCounter = document.getElementById('refresh-counter');
        const resetRefreshBtn = document.getElementById('reset-refresh');
        const msToggle = document.getElementById('ms-toggle');
        
        // 功能切换相关变量
        let currentFeature = localStorage.getItem('currentFeature') || 'time'; // 'time'、'countdown' 或 'stopwatch'
        let countdownDuration = parseInt(localStorage.getItem('countdownDuration') || '5'); // 默认5分钟
        let countdownEndTime = null;
        let countdownInterval = null;
        let isPaused = false;
        let pausedRemainingTime = 0;
        
        // 正计时相关变量
        let stopwatchStartTime = null;
        let stopwatchElapsedTime = 0; // 已流逝的时间（毫秒）
        let stopwatchIsRunning = false;
        let stopwatchIsPaused = false;
        
        // 开发者模式状态
        let errorCount = 0;
        const MAX_ERRORS = 5;
        const LOCK_TIME = 1 * 60 * 1000; // 1分钟
        const PASSWORD = '1313113';
        
        // 获取本地存储的错误信息
        function getErrorInfo() {
            const info = localStorage.getItem('devErrorInfo');
            if (info) {
                return JSON.parse(info);
            }
            return { count: 0, lockUntil: 0 };
        }
        
        // 保存错误信息到本地存储
        function saveErrorInfo(info) {
            localStorage.setItem('devErrorInfo', JSON.stringify(info));
        }
        
        // 检查是否被锁定
        function isLocked() {
            const info = getErrorInfo();
            return Date.now() < info.lockUntil;
        }
        
        // 获取剩余锁定时间
        function getRemainingLockTime() {
            const info = getErrorInfo();
            const remaining = info.lockUntil - Date.now();
            return remaining > 0 ? remaining : 0;
        }
        
        // 更新时间显示
        function updateTime() {
            const now = new Date();
            
            // 格式化日期信息
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const weekday = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'][now.getDay()];
            
            // 计算第几周
            const firstDay = new Date(year, 0, 1);
            const pastDays = (now - firstDay) / (24 * 60 * 60 * 1000);
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            
            // 格式化时间
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            // 获取毫秒显示状态
            const showMs = msToggle.checked;
            
            let timeString;
            if (showMs) {
                const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
                timeString = `${hours}:${minutes}:${seconds}.${milliseconds}`;
            } else {
                timeString = `${hours}:${minutes}:${seconds}`;
            }
            
            // 更新DOM
            dateInfo.textContent = `${year}年${month}月${day}日 ${weekday}，第${weekNumber}周`;
            timeElement.textContent = timeString;
        }
        
        // 全屏切换功能
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // 更新全屏按钮文本
        function updateFullscreenBtn() {
            if (document.fullscreenElement) {
                fullscreenBtn.textContent = '退出全屏';
            } else {
                fullscreenBtn.textContent = '全屏';
            }
        }
        
        // 显示弹窗
        function showModal(content) {
            modalBody.innerHTML = content;
            modal.style.display = 'flex';
        }
        
        // 隐藏弹窗
        function hideModal() {
            modal.style.display = 'none';
        }
        
        // 切换功能
        function switchFeature(feature) {
            if (currentFeature === feature) return;
            
            currentFeature = feature;
            localStorage.setItem('currentFeature', feature);
            
            // 清理之前的定时器
            clearInterval(window.timeInterval);
            
            // 获取设置区域
            const countdownSettingArea = document.getElementById('countdown-setting-area');
            const stopwatchSettingArea = document.getElementById('stopwatch-setting-area');
            
            if (feature === 'time') {
                // 切换到北京时间
                updateTime();
                const updateInterval = msToggle.checked ? 1 : 1000;
                window.timeInterval = setInterval(updateTime, updateInterval);
                // 显示日期信息
                dateInfo.style.display = 'block';
                // 隐藏所有设置区域
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'none';
                }
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'none';
                }
            } else if (feature === 'countdown') {
                // 切换到倒计时
                // 初始化倒计时，默认显示0:0:0.000
                countdownEndTime = null;
                updateCountdown();
                const updateInterval = msToggle.checked ? 100 : 1000;
                window.timeInterval = setInterval(updateCountdown, updateInterval);
                // 隐藏日期信息
                dateInfo.style.display = 'none';
                // 显示倒计时设置区域，隐藏正计时设置区域
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'block';
                    // 加载保存的倒计时时长
                    loadCountdownDuration();
                }
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'none';
                }
            } else if (feature === 'stopwatch') {
                // 切换到正计时
                // 初始化正计时，显示0:0:0.000
                resetStopwatch();
                const updateInterval = msToggle.checked ? 100 : 1000;
                window.timeInterval = setInterval(updateStopwatch, updateInterval);
                // 隐藏日期信息
                dateInfo.style.display = 'none';
                // 显示正计时设置区域，隐藏倒计时设置区域
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'block';
                }
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'none';
                }
            }
        }
        
        // 加载保存的倒计时时长
        function loadCountdownDuration() {
            const savedDuration = localStorage.getItem('countdownDuration');
            let totalSeconds = savedDuration ? parseInt(savedDuration) * 60 : 300; // 默认5分钟
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            const hoursInput = document.getElementById('countdown-hours');
            const minutesInput = document.getElementById('countdown-minutes');
            const secondsInput = document.getElementById('countdown-seconds');
            
            if (hoursInput) hoursInput.value = hours;
            if (minutesInput) minutesInput.value = minutes;
            if (secondsInput) secondsInput.value = seconds;
            
            // 更新显示
            updateCountdown();
        }
        
        // 更新预览倒计时显示
        function updatePreviewCountdown() {
            // 只有在倒计时未开始且未暂停时才更新预览
            if (countdownEndTime === null && !isPaused) {
                const countdownHours = document.getElementById('countdown-hours');
                const countdownMinutes = document.getElementById('countdown-minutes');
                const countdownSeconds = document.getElementById('countdown-seconds');
                
                if (countdownHours && countdownMinutes && countdownSeconds) {
                    const hours = parseInt(countdownHours.value) || 0;
                    const minutes = parseInt(countdownMinutes.value) || 0;
                    const seconds = parseInt(countdownSeconds.value) || 0;
                    
                    // 计算总毫秒数
                    const totalMilliseconds = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    
                    // 显示预览时间
                    const remaining = totalMilliseconds;
                    const previewHours = Math.floor(remaining / (1000 * 60 * 60));
                    const previewMinutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const previewSeconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    const previewMilliseconds = Math.floor((remaining % 1000) / 10);
                    
                    let timeString;
                    if (msToggle.checked) {
                        timeString = `${previewHours.toString().padStart(2, '0')}:${previewMinutes.toString().padStart(2, '0')}:${previewSeconds.toString().padStart(2, '0')}.${previewMilliseconds.toString().padStart(2, '0')}`;
                    } else {
                        timeString = `${previewHours.toString().padStart(2, '0')}:${previewMinutes.toString().padStart(2, '0')}:${previewSeconds.toString().padStart(2, '0')}`;
                    }
                    
                    timeElement.textContent = timeString;
                }
            }
        }
        
        // 开始倒计时
        function startCountdown() {
            const hoursInput = document.getElementById('countdown-hours');
            const minutesInput = document.getElementById('countdown-minutes');
            const secondsInput = document.getElementById('countdown-seconds');
            const pauseBtn = document.getElementById('pause-countdown-btn');
            
            if (hoursInput && minutesInput && secondsInput) {
                if (isPaused) {
                    // 继续暂停的倒计时
                    countdownEndTime = Date.now() + pausedRemainingTime;
                    isPaused = false;
                    pausedRemainingTime = 0;
                    if (pauseBtn) {
                        pauseBtn.textContent = '暂停';
                    }
                } else {
                    // 开始新的倒计时
                    const hours = parseInt(hoursInput.value) || 0;
                    const minutes = parseInt(minutesInput.value) || 0;
                    const seconds = parseInt(secondsInput.value) || 0;
                    
                    // 计算总时长（分钟）用于保存
                    const totalMinutes = hours * 60 + minutes + seconds / 60;
                    countdownDuration = Math.round(totalMinutes);
                    localStorage.setItem('countdownDuration', countdownDuration);
                    
                    // 计算总时长（毫秒）用于倒计时
                    const totalMilliseconds = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    countdownEndTime = Date.now() + totalMilliseconds;
                }
                
                // 显示暂停按钮
                if (pauseBtn) {
                    pauseBtn.style.display = 'inline-block';
                }
                
                updateCountdown();
            }
        }
        
        // 重置倒计时
        function resetCountdown() {
            countdownEndTime = null;
            isPaused = false;
            pausedRemainingTime = 0;
            
            // 将输入框的值归零
            const hoursInput = document.getElementById('countdown-hours');
            const minutesInput = document.getElementById('countdown-minutes');
            const secondsInput = document.getElementById('countdown-seconds');
            if (hoursInput) hoursInput.value = 0;
            if (minutesInput) minutesInput.value = 0;
            if (secondsInput) secondsInput.value = 0;
            
            // 隐藏暂停按钮
            const pauseBtn = document.getElementById('pause-countdown-btn');
            if (pauseBtn) {
                pauseBtn.style.display = 'none';
            }
            
            updateCountdown();
        }
        
        // 暂停/继续倒计时
        function pauseCountdown() {
            const pauseBtn = document.getElementById('pause-countdown-btn');
            
            if (isPaused) {
                // 继续倒计时
                countdownEndTime = Date.now() + pausedRemainingTime;
                isPaused = false;
                pausedRemainingTime = 0;
                if (pauseBtn) {
                    pauseBtn.textContent = '暂停';
                }
            } else {
                // 暂停倒计时
                const now = Date.now();
                pausedRemainingTime = Math.max(0, countdownEndTime - now);
                countdownEndTime = null;
                isPaused = true;
                if (pauseBtn) {
                    pauseBtn.textContent = '继续';
                }
            }
        }
        
        // 更新倒计时显示
        function updateCountdown() {
            let remaining;
            
            if (countdownEndTime === null) {
                if (isPaused) {
                    // 如果倒计时暂停，显示暂停时的剩余时间
                    remaining = pausedRemainingTime;
                } else {
                    // 如果倒计时未开始，显示用户输入的倒计时时长
                    const countdownHours = document.getElementById('countdown-hours');
                    const countdownMinutes = document.getElementById('countdown-minutes');
                    const countdownSeconds = document.getElementById('countdown-seconds');
                    
                    if (countdownHours && countdownMinutes && countdownSeconds) {
                        const hours = parseInt(countdownHours.value) || 0;
                        const minutes = parseInt(countdownMinutes.value) || 0;
                        const seconds = parseInt(countdownSeconds.value) || 0;
                        remaining = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    } else {
                        remaining = 0;
                    }
                }
            } else {
                // 否则计算剩余时间
                const now = Date.now();
                remaining = Math.max(0, countdownEndTime - now);
                
                // 如果倒计时结束，重置为未开始状态
                if (remaining <= 0) {
                    countdownEndTime = null;
                    isPaused = false;
                    pausedRemainingTime = 0;
                    // 隐藏暂停按钮
                    const pauseBtn = document.getElementById('pause-countdown-btn');
                    if (pauseBtn) {
                        pauseBtn.style.display = 'none';
                    }
                    
                    // 显示用户输入的倒计时时长
                    const countdownHours = document.getElementById('countdown-hours');
                    const countdownMinutes = document.getElementById('countdown-minutes');
                    const countdownSeconds = document.getElementById('countdown-seconds');
                    
                    if (countdownHours && countdownMinutes && countdownSeconds) {
                        const hours = parseInt(countdownHours.value) || 0;
                        const minutes = parseInt(countdownMinutes.value) || 0;
                        const seconds = parseInt(countdownSeconds.value) || 0;
                        remaining = (hours * 3600 + minutes * 60 + seconds) * 1000;
                    } else {
                        remaining = 0;
                    }
                }
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            const milliseconds = Math.floor((remaining % 1000) / 10);
            
            let timeString;
            // 总是显示小时、分钟、秒，根据毫秒显示设置决定是否显示毫秒
            if (msToggle.checked) {
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
            } else {
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            timeElement.textContent = timeString;
        }
        
        // 更新正计时显示
        function updateStopwatch() {
            let elapsed;
            
            if (stopwatchIsRunning && stopwatchStartTime) {
                // 如果正计时正在运行，计算从开始到现在的时间
                elapsed = stopwatchElapsedTime + (Date.now() - stopwatchStartTime);
            } else {
                // 否则显示已流逝的时间（包括暂停状态）
                elapsed = stopwatchElapsedTime;
            }
            
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            const milliseconds = Math.floor((elapsed % 1000) / 10);
            
            let timeString;
            // 总是显示小时、分钟、秒，根据毫秒显示设置决定是否显示毫秒
            if (msToggle.checked) {
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
            } else {
                timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            timeElement.textContent = timeString;
        }
        
        // 开始正计时
        function startStopwatch() {
            const startBtn = document.getElementById('start-stopwatch-btn');
            const pauseBtn = document.getElementById('pause-stopwatch-btn');
            
            if (stopwatchIsPaused) {
                // 继续暂停的正计时
                stopwatchStartTime = Date.now();
                stopwatchIsRunning = true;
                stopwatchIsPaused = false;
            } else {
                // 开始新的正计时
                stopwatchStartTime = Date.now();
                stopwatchIsRunning = true;
                stopwatchIsPaused = false;
            }
            
            // 显示暂停按钮，隐藏开始按钮
            if (pauseBtn) {
                pauseBtn.style.display = 'inline-block';
                pauseBtn.textContent = '暂停';
            }
            if (startBtn) {
                startBtn.style.display = 'none';
            }
            
            updateStopwatch();
        }
        
        // 重置正计时
        function resetStopwatch() {
            const startBtn = document.getElementById('start-stopwatch-btn');
            const pauseBtn = document.getElementById('pause-stopwatch-btn');
            
            stopwatchIsRunning = false;
            stopwatchIsPaused = false;
            stopwatchStartTime = null;
            stopwatchElapsedTime = 0;
            
            // 显示开始按钮，隐藏暂停按钮
            if (startBtn) {
                startBtn.style.display = 'inline-block';
            }
            if (pauseBtn) {
                pauseBtn.style.display = 'none';
            }
            
            updateStopwatch();
        }
        
        // 暂停/继续正计时
        function pauseStopwatch() {
            const startBtn = document.getElementById('start-stopwatch-btn');
            const pauseBtn = document.getElementById('pause-stopwatch-btn');
            
            if (stopwatchIsPaused) {
                // 继续正计时
                stopwatchStartTime = Date.now();
                stopwatchIsRunning = true;
                stopwatchIsPaused = false;
                if (pauseBtn) {
                    pauseBtn.textContent = '暂停';
                }
                if (startBtn) {
                    startBtn.style.display = 'none';
                }
                if (pauseBtn) {
                    pauseBtn.style.display = 'inline-block';
                }
            } else {
                // 暂停正计时
                if (stopwatchIsRunning && stopwatchStartTime) {
                    stopwatchElapsedTime += (Date.now() - stopwatchStartTime);
                }
                stopwatchIsRunning = false;
                stopwatchIsPaused = true;
                stopwatchStartTime = null;
                if (pauseBtn) {
                    pauseBtn.textContent = '继续';
                }
                if (startBtn) {
                    startBtn.style.display = 'none';
                }
            }
        }
        
        // 显示检测环境动效
        function showEnvironmentCheck() {
            const content = `
                <h2>制作人员名单</h2>
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">正在检测锁定状态</div>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            showModal(content);
            
            // 模拟检测环境，2秒后显示密码输入界面（带通过效果）
            setTimeout(() => {
                showPasswordInput(true);
            }, 2000);
        }
        
        // 显示制作人员名单确认弹窗
        function showDevConfirm() {
            const content = `
                <h2>制作人员名单</h2>
                <p>确定显示制作人员？</p>
                <div class="btn-container">
                    <button class="btn btn-green" id="confirm-continue">继续</button>
                    <button class="btn btn-red" id="confirm-cancel">取消</button>
                </div>
            `;
            showModal(content);
            
            // 添加事件监听器
            document.getElementById('confirm-continue').addEventListener('click', showEnvironmentCheck);
            document.getElementById('confirm-cancel').addEventListener('click', hideModal);
        }
        
        // 显示密码输入弹窗
        function showPasswordInput(showSuccess = false) {
            // 检查是否被锁定
            if (isLocked()) {
                let countdownTimer;
                
                // 更新剩余时间
                function updateRemainingTime() {
                    const remaining = Math.ceil(getRemainingLockTime() / 1000);
                    if (remaining <= 0) {
                        // 锁定时间已过，重新检测环境
                        clearInterval(countdownTimer);
                        hideModal();
                        showEnvironmentCheck();
                        return;
                    }
                    
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    const timeElement = document.getElementById('lock-time');
                    if (timeElement) {
                        timeElement.textContent = `${minutes}分${seconds}秒`;
                    }
                }
                
                const content = `
                    <h2>制作人员名单</h2>
                    <div class="loading-container">
                        <div class="error-check"></div>
                        <div class="error-text">锁定检测未通过</div>
                        <p style="color: #ddd; margin-top: 10px;">请<span id="lock-time">0分0秒</span>后重试</p>
                        <p style="color: #ddd; margin-top: 5px;">锁定时可正常使用时间</p>
                    </div>
                    <div class="btn-container" style="margin-top: 20px;">
                        <button class="btn btn-red" id="lock-cancel">关闭</button>
                    </div>
                `;
                showModal(content);
                
                // 初始化显示时间
                updateRemainingTime();
                // 启动倒计时定时器
                countdownTimer = setInterval(updateRemainingTime, 1000);
                
                // 取消按钮事件，清除定时器
                document.getElementById('lock-cancel').addEventListener('click', () => {
                    clearInterval(countdownTimer);
                    hideModal();
                });
                
                // 关闭按钮事件，清除定时器
                modalClose.addEventListener('click', () => {
                    clearInterval(countdownTimer);
                    hideModal();
                });
                
                // 点击弹窗外部事件，清除定时器
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        clearInterval(countdownTimer);
                        hideModal();
                    }
                });
                
                return;
            }
            
            // 构建密码输入界面内容，根据showSuccess参数决定是否显示环境检测通过效果
            const successSection = showSuccess ? `
                <div class="loading-container" style="margin-bottom: 20px;">
                    <div class="success-check"></div>
                    <div class="success-text">锁定检测通过</div>
                </div>
            ` : '';
            
            const content = `
                <h2>制作人员名单</h2>
                ${successSection}
                <p>请输入访问密码</p>
                <div class="input-container">
                    <input type="password" id="password-input" placeholder="机会有限">
                </div>
                <div class="error-msg" id="password-error" style="display: none;"></div>
                <div class="btn-container">
                    <button class="btn btn-blue" id="password-confirm">确定</button>
                    <button class="btn btn-red" id="password-cancel">取消</button>
                </div>
            `;
            showModal(content);
            
            // 添加事件监听器
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            
            document.getElementById('password-confirm').addEventListener('click', () => {
                const password = passwordInput.value;
                if (password === PASSWORD) {
                    // 密码正确，重置错误计数
                    saveErrorInfo({ count: 0, lockUntil: 0 });
                    showCreatorInfo();
                } else {
                    // 密码错误，更新错误计数
                    const errorInfo = getErrorInfo();
                    errorInfo.count++;
                    
                    if (errorInfo.count >= MAX_ERRORS) {
                        // 锁定10分钟
                        errorInfo.lockUntil = Date.now() + LOCK_TIME;
                        const remaining = Math.ceil(LOCK_TIME / 1000);
                        const minutes = Math.floor(remaining / 60);
                        const seconds = remaining % 60;
                        passwordError.textContent = `密码错误，已被锁定${minutes}分${seconds}秒`;
                        passwordError.style.display = 'block';
                        
                        // 1秒后显示锁定弹窗
                        setTimeout(() => {
                            showPasswordInput(false);
                        }, 1000);
                    } else {
                        passwordError.textContent = `密码错误（${errorInfo.count}/${MAX_ERRORS}），剩余${MAX_ERRORS - errorInfo.count}次机会`;
                        passwordError.style.display = 'block';
                    }
                    
                    saveErrorInfo(errorInfo);
                }
            });
            
            document.getElementById('password-cancel').addEventListener('click', hideModal);
        }
        
        // 显示设置弹窗
        function showSettingsModal() {
            const content = `
                <h2 style="margin-bottom: 20px;">更多</h2>
                <div style="display: flex; gap: 20px; width: 700px; height: 400px;">
                    <!-- 左侧导航 -->
                    <div style="width: 200px; background-color: rgba(50, 50, 50, 0.5); border-radius: 8px; padding: 15px;">
                        <div style="margin-bottom: 20px;"></div>
                        <div class="settings-nav-item active" data-category="general" style="padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: rgba(255, 255, 255, 0.2); color: #fff;">通用</div>
                        <div class="settings-nav-item" data-category="features" style="padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: transparent; color: #aaa;">功能</div>
                        <div class="settings-nav-item" data-category="about" style="padding: 12px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: transparent; color: #aaa;">关于</div>
                    </div>
                    
                    <!-- 右侧内容 -->
                    <div style="flex: 1; background-color: rgba(50, 50, 50, 0.5); border-radius: 8px; padding: 25px;">
                        <!-- 通用设置 -->
                        <div id="settings-general" class="settings-content">
                            <h3 style="margin-bottom: 25px; color: #fff; font-size: 18px;">通用</h3>
                            <div class="option-item" style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
                                <span class="option-label" style="font-size: 16px;">显示毫秒</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ms-toggle-modal" ${msToggle.checked ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="option-item">
                                <span class="option-label" style="font-size: 14px; color: #888;">说明：关闭毫秒显示可减少屏幕刷新频率，延长屏幕寿命</span>
                            </div>
                        </div>
                        
                        <!-- 功能设置 -->
                        <div id="settings-features" class="settings-content" style="display: none;">
                            <h3 style="margin-bottom: 25px; color: #fff; font-size: 18px;">功能</h3>
                            <div class="option-item" style="margin-bottom: 25px;">
                                <span class="option-label" style="font-size: 16px; margin-bottom: 15px; display: block;">功能切换</span>
                                <div style="display: flex; gap: 15px;">
                                    <button class="feature-btn time-active" data-feature="time" style="padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: ${currentFeature === 'time' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(50, 50, 50, 0.8)'};
 color: ${currentFeature === 'time' ? '#fff' : '#aaa'};">北京时间</button>
                                    <button class="feature-btn countdown-active" data-feature="countdown" style="padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: ${currentFeature === 'countdown' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(50, 50, 50, 0.8)'};
 color: ${currentFeature === 'countdown' ? '#fff' : '#aaa'};">倒计时</button>
                                    <button class="feature-btn stopwatch-active" data-feature="stopwatch" style="padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s; background-color: ${currentFeature === 'stopwatch' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(50, 50, 50, 0.8)'};
 color: ${currentFeature === 'stopwatch' ? '#fff' : '#aaa'};">正计时</button>
                                </div>
                            </div>
                            
                            <!-- 学校模式设置 -->
                            <div class="option-item" style="margin-bottom: 25px; padding-top: 20px; border-top: 1px solid #333;">
                                <span class="option-label" style="font-size: 16px; margin-bottom: 15px; display: block;">学校模式</span>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="school-mode-toggle" ${localStorage.getItem('schoolMode') === 'true' ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 学校模式功能区 -->
                            <div id="school-mode-features" class="option-item" style="${localStorage.getItem('schoolMode') === 'true' ? 'display: block;' : 'display: none;'} margin-bottom: 25px; padding: 15px; background-color: rgba(50, 50, 50, 0.5); border-radius: 8px;">
                                <div style="display: flex; gap: 15px; justify-content: center; align-items: center; margin-top: 10px;">
                                    <button class="btn btn-blue" id="exam-mode-btn" style="padding: 12px 24px; font-size: 16px;">${localStorage.getItem('examMode') === 'true' ? '关闭考试模式' : '启动考试模式'}</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 关于设置 -->
                        <div id="settings-about" class="settings-content" style="display: none;">
                            <h3 style="margin-bottom: 25px; color: #fff; font-size: 18px;">关于</h3>
                            <div class="option-item" style="border-bottom: 1px solid #333; margin-bottom: 25px; padding-bottom: 25px;">
                                <button class="btn btn-blue" style="width: 100%; padding: 12px; font-size: 16px;" id="show-creator-btn">制作人员名单</button>
                            </div>
                            <div class="option-item" style="text-align: center; margin-top: 30px;">
                                <div style="color: #aaa; font-size: 14px; margin-bottom: 15px;">v4.1.0</div>
                                <a href="https://beijingfortime.wordpress.com/" target="_blank" rel="noopener noreferrer" style="font-size: 14px; opacity: 0.8; text-decoration: underline; color: #aaa;">官网</a>
                            </div>
                            <div style="text-align: center; color: #888; font-size: 12px; margin-top: 20px;">
                                此程序免费试用，
                                <a href="https://ifdian.net/order/create?plan_id=b7c1d2cecf5b11ef88ad52540025c377&product_type=0&remark=&affiliate_code=" 
                                   target="_blank" rel="noopener noreferrer" style="color: #4CAF50; text-decoration: underline;">
                                    赞助作者
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .modal-content {
                        min-width: 800px;
                        min-height: 500px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    }
                    .settings-nav-item:hover {
                        background-color: rgba(255, 255, 255, 0.1) !important;
                        color: #ddd !important;
                    }
                    .settings-nav-item.active {
                        background-color: rgba(255, 255, 255, 0.2) !important;
                        color: #fff !important;
                    }
                </style>
            `;
            showModal(content);
            
            // 添加事件监听器
            document.getElementById('ms-toggle-modal').addEventListener('change', (e) => {
                msToggle.checked = e.target.checked;
                // 保存设置到本地存储
                localStorage.setItem('showMilliseconds', msToggle.checked);
                // 更新显示
                if (currentFeature === 'time') {
                    updateTime();
                } else if (currentFeature === 'countdown') {
                    updateCountdown();
                } else if (currentFeature === 'stopwatch') {
                    updateStopwatch();
                }
                // 重新设置更新频率
                clearInterval(window.timeInterval);
                const updateInterval = msToggle.checked ? 100 : 1000;
                if (currentFeature === 'time') {
                    window.timeInterval = setInterval(updateTime, updateInterval);
                } else if (currentFeature === 'countdown') {
                    window.timeInterval = setInterval(updateCountdown, updateInterval);
                } else if (currentFeature === 'stopwatch') {
                    window.timeInterval = setInterval(updateStopwatch, updateInterval);
                }
            });
            
            document.getElementById('show-creator-btn').addEventListener('click', () => {
                hideModal();
                showEnvironmentCheck();
            });
            
            // 学校模式开关事件
            document.getElementById('school-mode-toggle').addEventListener('change', (e) => {
                const isSchoolMode = e.target.checked;
                localStorage.setItem('schoolMode', isSchoolMode);
                
                // 显示/隐藏学校模式功能区
                const schoolModeFeatures = document.getElementById('school-mode-features');
                if (schoolModeFeatures) {
                    schoolModeFeatures.style.display = isSchoolMode ? 'block' : 'none';
                }
                
                // 如果关闭学校模式，自动关闭考试模式
                if (!isSchoolMode) {
                    const isExamMode = localStorage.getItem('examMode') === 'true';
                    if (isExamMode) {
                        deactivateExamMode();
                        // 更新按钮文本
                        const examModeBtn = document.getElementById('exam-mode-btn');
                        if (examModeBtn) {
                            examModeBtn.textContent = '启动考试模式';
                        }
                    }
                }
            });
            
            // 考试模式按钮事件
            document.getElementById('exam-mode-btn').addEventListener('click', () => {
                const currentExamMode = localStorage.getItem('examMode') === 'true';
                const newExamMode = !currentExamMode;
                
                if (newExamMode) {
                    // 启动考试模式
                    showModal(`
                        <h2>考试模式</h2>
                        <p>确认启动考试模式？</p>
                        <p style="color: #aaa; font-size: 14px; margin: 10px 0;">启动后将隐藏所有不必要的元素，仅显示时间</p>
                        <div class="btn-container">
                            <button class="btn btn-green" id="confirm-exam-start">确定</button>
                            <button class="btn btn-red" id="confirm-exam-cancel">取消</button>
                        </div>
                    `);
                    
                    document.getElementById('confirm-exam-start').addEventListener('click', () => {
                        hideModal();
                        activateExamMode();
                    });
                    
                    document.getElementById('confirm-exam-cancel').addEventListener('click', hideModal);
                } else {
                    // 关闭考试模式
                    deactivateExamMode();
                    // 更新按钮文本
                    document.getElementById('exam-mode-btn').textContent = '启动考试模式';
                    hideModal();
                }
            });
            
            
            
            // 添加设置分类切换事件
            const navItems = document.querySelectorAll('.settings-nav-item');
            const contentItems = document.querySelectorAll('.settings-content');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    // 移除所有active类和样式
                    navItems.forEach(nav => {
                        nav.classList.remove('active');
                        nav.style.backgroundColor = 'transparent';
                        nav.style.color = '#aaa';
                    });
                    
                    // 隐藏所有内容
                    contentItems.forEach(content => content.style.display = 'none');
                    
                    // 添加当前active类和样式
                    item.classList.add('active');
                    item.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    item.style.color = '#fff';
                    
                    // 显示当前内容
                    const category = item.dataset.category;
                    const contentElement = document.getElementById(`settings-${category}`);
                    if (contentElement) {
                        contentElement.style.display = 'block';
                    }
                });
            });
            // 处理功能切换事件
            // 这里简化处理，直接使用事件委托
            const featuresContent = document.getElementById('settings-features');
            if (featuresContent) {
                featuresContent.addEventListener('click', (e) => {
                    // 功能切换按钮点击
                    if (e.target.classList.contains('feature-btn')) {
                        const feature = e.target.dataset.feature;
                        // 更新所有功能按钮样式
                        const featureBtns = featuresContent.querySelectorAll('.feature-btn');
                        featureBtns.forEach(btn => {
                            if (btn.dataset.feature === feature) {
                                btn.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                                btn.style.color = '#fff';
                            } else {
                                btn.style.backgroundColor = 'rgba(50, 50, 50, 0.8)';
                                btn.style.color = '#aaa';
                            }
                        });
                        // 切换功能
                        switchFeature(feature);
                    }
                });
            }
        }
        
        // 显示制作者信息
        function showCreatorInfo() {
            const content = `
                <div class="creator-info">制作者</div>
                <div class="creator-name"> </div>
                <div class="creator-name">HBC</div>
                <div class="creator-name"> </div>
                <div class="creator-name"> </div>
                <div style="margin-top: 10px; color: #aaa; font-size: 16px;">感谢使用！</div>
            `;
            showModal(content);
        }
        
        // 考试模式提示元素
        let examModeHint = null;
        
        // 激活考试模式
        function activateExamMode() {
            localStorage.setItem('examMode', 'true');
            
            // 隐藏多余元素
            const elementsToHide = [
                'check-update-btn',
                'fullscreen-btn',
                'refresh-container',
                'countdown-setting-area',
                'stopwatch-setting-area'
            ];
            
            elementsToHide.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // 确保设置按钮可见
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.style.display = 'block';
            }
            
            // 添加恢复提示
            if (!examModeHint) {
                examModeHint = document.createElement('div');
                examModeHint.id = 'exam-mode-hint';
                examModeHint.style.cssText = `
                    margin-top: 30px;
                    color: #aaa;
                    font-size: 16px;
                    text-align: center;
                `;
                examModeHint.textContent = '恢复正常：更多>功能>关闭考试模式';
                
                const timeContainer = document.getElementById('time-container');
                if (timeContainer) {
                    timeContainer.parentNode.insertBefore(examModeHint, timeContainer.nextSibling);
                }
            } else {
                examModeHint.style.display = 'block';
            }
        }
        
        // 关闭考试模式
        function deactivateExamMode() {
            localStorage.setItem('examMode', 'false');
            
            // 显示所有元素
            const elementsToShow = [
                'check-update-btn',
                'fullscreen-btn',
                'refresh-container'
            ];
            
            elementsToShow.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = '';
                }
            });
            
            // 根据当前功能显示相应的设置区域
            if (currentFeature === 'countdown') {
                const countdownArea = document.getElementById('countdown-setting-area');
                if (countdownArea) {
                    countdownArea.style.display = 'block';
                }
            } else if (currentFeature === 'stopwatch') {
                const stopwatchArea = document.getElementById('stopwatch-setting-area');
                if (stopwatchArea) {
                    stopwatchArea.style.display = 'block';
                }
            }
            
            // 隐藏恢复提示
            if (examModeHint) {
                examModeHint.style.display = 'none';
            }
        }
        
        // 重置刷新次数功能
        function resetRefreshCount() {
            // 清除localStorage中的刷新信息
            localStorage.removeItem('refreshInfo');
            
            // 更新显示
            refreshCounter.textContent = '您今日已刷新 0 次';
            refreshCounter.style.color = '#666';
            refreshCounter.style.opacity = '0.7';
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 全屏按钮事件
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // 全屏状态变化事件
            document.addEventListener('fullscreenchange', updateFullscreenBtn);
            
            // 检查更新按钮事件
            checkUpdateBtn.addEventListener('click', manualCheckUpdate);
            
            // 添加检查更新按钮鼠标悬停效果
            checkUpdateBtn.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#444';
                this.style.color = '#ccc';
            });
            
            checkUpdateBtn.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#333';
                this.style.color = '#aaa';
            });
            
            // 设置按钮事件
            settingsBtn.addEventListener('click', showSettingsModal);
            
            // 添加设置按钮鼠标悬停效果
            settingsBtn.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#444';
                this.style.color = '#ccc';
            });
            
            settingsBtn.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#333';
                this.style.color = '#aaa';
            });
            
            // 关闭弹窗事件
            modalClose.addEventListener('click', hideModal);
            
            // 点击弹窗外部关闭弹窗
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });
            
            // 重置刷新次数按钮事件
            resetRefreshBtn.addEventListener('click', (e) => {
                e.preventDefault(); // 阻止默认跳转行为
                resetRefreshCount();
            });
            
            // 开始倒计时按钮事件
            const startCountdownBtn = document.getElementById('start-countdown-btn');
            if (startCountdownBtn) {
                startCountdownBtn.addEventListener('click', startCountdown);
            }
            
            // 重置倒计时按钮事件
            const resetCountdownBtn = document.getElementById('reset-countdown-btn');
            if (resetCountdownBtn) {
                resetCountdownBtn.addEventListener('click', resetCountdown);
            }
            
            // 暂停倒计时按钮事件
            const pauseCountdownBtn = document.getElementById('pause-countdown-btn');
            if (pauseCountdownBtn) {
                pauseCountdownBtn.addEventListener('click', pauseCountdown);
            }
            
            // 倒计时输入框事件，用于实时更新计时器显示
            const countdownHours = document.getElementById('countdown-hours');
            const countdownMinutes = document.getElementById('countdown-minutes');
            const countdownSeconds = document.getElementById('countdown-seconds');
            
            // 移除updatePreviewCountdown事件监听器，使用updateCountdown代替
            if (countdownHours) {
                countdownHours.addEventListener('input', updateCountdown);
            }
            if (countdownMinutes) {
                countdownMinutes.addEventListener('input', updateCountdown);
            }
            if (countdownSeconds) {
                countdownSeconds.addEventListener('input', updateCountdown);
            }
            
            // 正计时按钮事件监听器
            const startStopwatchBtn = document.getElementById('start-stopwatch-btn');
            if (startStopwatchBtn) {
                startStopwatchBtn.addEventListener('click', startStopwatch);
            }
            
            const resetStopwatchBtn = document.getElementById('reset-stopwatch-btn');
            if (resetStopwatchBtn) {
                resetStopwatchBtn.addEventListener('click', resetStopwatch);
            }
            
            const pauseStopwatchBtn = document.getElementById('pause-stopwatch-btn');
            if (pauseStopwatchBtn) {
                pauseStopwatchBtn.addEventListener('click', pauseStopwatch);
            }
        }
        
        // 更新制作人员名单按钮文本（已废弃，不再使用）
        function updateDevBtnText() {
            // 函数已废弃，不再使用
        }
        
        // 获取当前日期（格式：YYYY-MM-DD）
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        // 重置刷新次数
        function resetDailyRefreshCount() {
            const today = getTodayDate();
            const refreshInfo = { count: 0, date: today };
            localStorage.setItem('refreshInfo', JSON.stringify(refreshInfo));
            refreshCounter.textContent = `您今日已刷新 0 次`;
            refreshCounter.style.color = '#666';
            refreshCounter.style.opacity = '0.7';
        }
        
        // 检查是否需要重置刷新次数
        function checkAndResetRefreshCount() {
            const today = getTodayDate();
            let refreshInfo = localStorage.getItem('refreshInfo');
            
            if (refreshInfo) {
                refreshInfo = JSON.parse(refreshInfo);
                if (refreshInfo.date !== today) {
                    resetDailyRefreshCount();
                }
            } else {
                resetDailyRefreshCount();
            }
        }
        
        // 设置每天0点自动重置刷新次数的定时器
        function setupDailyResetTimer() {
            // 获取当前时间
            const now = new Date();
            // 计算距离当天结束的时间（毫秒）
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            const timeUntilMidnight = tomorrow.getTime() - now.getTime();
            
            // 设置定时器，在当天结束时重置刷新次数
            setTimeout(() => {
                resetDailyRefreshCount();
                // 每天重复设置定时器
                setupDailyResetTimer();
            }, timeUntilMidnight);
        }
        
        // 刷新次数计数功能
        function updateRefreshCount() {
            // 先检查是否需要重置
            checkAndResetRefreshCount();
            
            const today = getTodayDate();
            
            // 从localStorage获取刷新信息
            let refreshInfo = localStorage.getItem('refreshInfo');
            if (!refreshInfo) {
                // 第一次使用，初始化
                refreshInfo = { count: 0, date: today };
            } else {
                refreshInfo = JSON.parse(refreshInfo);
            }
            
            // 刷新次数+1
            refreshInfo.count++;
            
            // 保存到localStorage
            localStorage.setItem('refreshInfo', JSON.stringify(refreshInfo));
            
            // 检查是否为不合规数字
            const invalidNumbers = [78, 91, 9178, 7891, 250];
            if (invalidNumbers.includes(refreshInfo.count)) {
                refreshCounter.textContent = '刷新数字不合规';
                // 可以添加样式变化，让提示更明显
                refreshCounter.style.color = '#f44336';
                refreshCounter.style.opacity = '0.9';
            } else {
                refreshCounter.textContent = `您今日已刷新 ${refreshInfo.count} 次`;
                // 恢复默认样式
                refreshCounter.style.color = '#666';
                refreshCounter.style.opacity = '0.7';
            }
            
            // 检查是否为感情数字，显示祝福弹窗
            const loveNumbers = [520, 1314, 1314520, 5201314];
            if (loveNumbers.includes(refreshInfo.count)) {
                // 感情祝福语录数组
                const loveMessages = [
                    `您今日已刷新 ${refreshInfo.count} 次，愿你拥有美好的爱情！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿天下有情人终成眷属！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿你的生活充满爱与温暖！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿每一个日子都有爱的陪伴！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿爱与你同在！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿你的爱情如蜜般甜美！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿你被世界温柔以待！`,
                    `您今日已刷新 ${refreshInfo.count} 次，愿你的心永远被爱填满！`
                ];
                
                // 随机选择一条祝福语
                const randomMessage = loveMessages[Math.floor(Math.random() * loveMessages.length)];
                
                // 显示祝福弹窗
                const content = `
                    <h2>💖 祝福</h2>
                    <p style="font-size: 18px; color: #4CAF50; margin: 20px 0;">${randomMessage}</p>
                    <div class="btn-container">
                        <button class="btn btn-green" id="love-ok">好的</button>
                    </div>
                `;
                showModal(content);
                
                // 好的按钮事件
                document.getElementById('love-ok').addEventListener('click', hideModal);
            }
        }
        
        // 检查新版本并显示更新内容
        function checkForUpdates() {
            // 当前版本
            const currentVersion = '4.1.0';
            
            // 从update.json获取最新版本
            fetch('/update.json', {
                cache: 'no-cache', // 不使用缓存，确保从服务器获取最新内容
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    // 检查是否有新版本
                    if (data.version !== currentVersion) {
                        // 检查是否已经显示过该版本的更新内容
                        const shownVersions = JSON.parse(localStorage.getItem('shownVersions') || '[]');
                        if (!shownVersions.includes(data.version)) {
                            // 显示更新内容
                            let changelogHTML = '<ul style="list-style-type: none; padding: 0; margin: 20px 0;">';
                            data.changelog.forEach(item => {
                                changelogHTML += `<li style="margin: 8px 0; padding-left: 20px; position: relative;">\n`;
                                changelogHTML += `  <span style="position: absolute; left: 0; color: #4CAF50;">•</span>\n`;
                                changelogHTML += `  ${item}\n`;
                                changelogHTML += `</li>`;
                            });
                            changelogHTML += '</ul>';
                            
                            const content = `
                                <h2 style="text-align: left;">版本 ${data.version} 更新内容</h2>
                                <div style="margin: 20px 0; text-align: left;">
                                    ${changelogHTML}
                                </div>
                                <div style="color: #aaa; font-size: 14px; margin-top: 20px; text-align: left;">
                                    最后更新：${data.lastUpdate}
                                </div>
                                <div class="btn-container" style="margin-top: 30px; justify-content: flex-start;">
                                    <button class="btn btn-green" id="update-content-ok">确定</button>
                                </div>
                            `;
                            showModal(content);
                            
                            // 确定按钮事件
                            document.getElementById('update-content-ok').addEventListener('click', hideModal);
                            
                            // 记录已显示的版本
                            shownVersions.push(data.version);
                            localStorage.setItem('shownVersions', JSON.stringify(shownVersions));
                        }
                    }
                })
                .catch(error => {
                    console.log('获取更新内容失败:', error);
                });
        }
        
        // 初始化
        function init() {
            // 从本地存储加载设置
            const savedShowMs = localStorage.getItem('showMilliseconds');
            if (savedShowMs !== null) {
                msToggle.checked = savedShowMs === 'true';
            }
            
            // 从本地存储加载功能状态和倒计时时长
            currentFeature = localStorage.getItem('currentFeature') || 'time';
            const savedDuration = localStorage.getItem('countdownDuration');
            if (savedDuration !== null) {
                countdownDuration = parseInt(savedDuration);
            }
            
            // 根据功能状态启动相应的更新
            if (currentFeature === 'time') {
                // 启动北京时间更新
                updateTime();
                const updateInterval = msToggle.checked ? 1 : 1000;
                window.timeInterval = setInterval(updateTime, updateInterval);
                // 显示日期信息
                dateInfo.style.display = 'block';
                // 隐藏所有设置区域
                const countdownSettingArea = document.getElementById('countdown-setting-area');
                const stopwatchSettingArea = document.getElementById('stopwatch-setting-area');
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'none';
                }
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'none';
                }
            } else if (currentFeature === 'countdown') {
                // 初始化倒计时，默认显示0:0:0.000
                countdownEndTime = null;
                updateCountdown();
                const updateInterval = msToggle.checked ? 100 : 1000;
                window.timeInterval = setInterval(updateCountdown, updateInterval);
                // 隐藏日期信息
                dateInfo.style.display = 'none';
                // 显示倒计时设置区域，隐藏正计时设置区域
                const countdownSettingArea = document.getElementById('countdown-setting-area');
                const stopwatchSettingArea = document.getElementById('stopwatch-setting-area');
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'block';
                    // 加载保存的倒计时时长
                    loadCountdownDuration();
                }
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'none';
                }
            } else if (currentFeature === 'stopwatch') {
                // 初始化正计时，显示0:0:0.000
                resetStopwatch();
                const updateInterval = msToggle.checked ? 100 : 1000;
                window.timeInterval = setInterval(updateStopwatch, updateInterval);
                // 隐藏日期信息
                dateInfo.style.display = 'none';
                // 显示正计时设置区域，隐藏倒计时设置区域
                const stopwatchSettingArea = document.getElementById('stopwatch-setting-area');
                const countdownSettingArea = document.getElementById('countdown-setting-area');
                if (stopwatchSettingArea) {
                    stopwatchSettingArea.style.display = 'block';
                }
                if (countdownSettingArea) {
                    countdownSettingArea.style.display = 'none';
                }
            }
            
            // 初始化事件监听器
            initEventListeners();
            
            // 初始化全屏按钮文本
            updateFullscreenBtn();
            
            // 设置每天0点自动重置刷新次数的定时器
            setupDailyResetTimer();
            
            // 更新并显示刷新次数
            updateRefreshCount();
        }
        
        // Service Worker注册和自动更新功能
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then((registration) => {
                            console.log('Service Worker 注册成功:', registration.scope);
                            
                            // 监听更新事件
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // 新的Service Worker已安装，显示更新提示
                                        showUpdateNotification();
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            console.log('Service Worker 注册失败:', error);
                        });
                });
                
                // 监听控制变化事件
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    refreshing = true;
                    window.location.reload();
                });
            }
        }
        
        // 显示更新通知
        function showUpdateNotification() {
            const content = `
                <h2>🎉 发现新版本</h2>
                <p>页面已更新，是否立即刷新获取最新内容？</p>
                <div class="btn-container">
                    <button class="btn btn-green" id="update-now">立即刷新</button>
                    <button class="btn btn-red" id="update-later">稍后更新</button>
                </div>
            `;
            showModal(content);
            
            // 添加事件监听
            document.getElementById('update-now').addEventListener('click', () => {
                hideModal();
                // 发送消息给Service Worker，要求跳过等待
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
            });
            
            document.getElementById('update-later').addEventListener('click', hideModal);
        }
        
        // 显示更新内容函数
        function manualCheckUpdate() {
            // 本地默认更新内容，确保即使网络失败也能显示
            const defaultUpdateData = {
                version: '4.1.0',
                lastUpdate: '2025-12-08',
                changelog: [
                    "修复关于页面显示问题",
                    "添加学校模式和考试模式功能",
                    "删除返回桌面功能",
                    "优化学校模式逻辑，关闭时自动关闭考试模式",
                    "简化学校模式界面，移除解释文字"
                ]
            };
            
            // 从update.json获取更新内容
            fetch('/update.json', {
                cache: 'no-cache', // 不使用缓存，确保从服务器获取最新内容
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    // 检查data是否包含必要的字段，否则使用默认数据
                    if (!data || !data.version || !Array.isArray(data.changelog)) {
                        data = defaultUpdateData;
                    }
                    
                    // 构建更新内容HTML
                    let changelogHTML = '<ul style="list-style-type: none; padding: 0; margin: 20px 0;">';
                    data.changelog.forEach(item => {
                        changelogHTML += `<li style="margin: 8px 0; padding-left: 20px; position: relative;">\n`;
                        changelogHTML += `  <span style="position: absolute; left: 0; color: #4CAF50;">•</span>\n`;
                        changelogHTML += `  ${item}\n`;
                        changelogHTML += `</li>`;
                    });
                    changelogHTML += '</ul>';
                    
                    // 显示更新内容弹窗
                    const content = `
                        <h2 style="text-align: left;">版本 ${data.version} 更新内容</h2>
                        <div style="margin: 20px 0; text-align: left;">
                            ${changelogHTML}
                        </div>
                        <div style="color: #aaa; font-size: 14px; margin-top: 20px; text-align: left;">
                            最后更新：${data.lastUpdate}
                        </div>
                        <div class="btn-container" style="margin-top: 30px; justify-content: flex-start;">
                            <button class="btn btn-green" id="update-content-ok">确定</button>
                        </div>
                    `;
                    showModal(content);
                    
                    // 确定按钮事件
                    document.getElementById('update-content-ok').addEventListener('click', hideModal);
                })
                .catch(error => {
                    console.log('获取更新内容失败，使用默认数据:', error);
                    
                    // 使用默认数据显示更新内容
                    const data = defaultUpdateData;
                    
                    // 构建更新内容HTML
                    let changelogHTML = '<ul style="list-style-type: none; padding: 0; margin: 20px 0;">';
                    data.changelog.forEach(item => {
                        changelogHTML += `<li style="margin: 8px 0; padding-left: 20px; position: relative;">\n`;
                        changelogHTML += `  <span style="position: absolute; left: 0; color: #4CAF50;">•</span>\n`;
                        changelogHTML += `  ${item}\n`;
                        changelogHTML += `</li>`;
                    });
                    changelogHTML += '</ul>';
                    
                    // 显示更新内容弹窗
                    const content = `
                        <h2 style="text-align: left;">版本 ${data.version} 更新内容</h2>
                        <div style="margin: 20px 0; text-align: left;">
                            ${changelogHTML}
                        </div>
                        <div style="color: #aaa; font-size: 14px; margin-top: 20px; text-align: left;">
                            最后更新：${data.lastUpdate}
                        </div>
                        <div class="btn-container" style="margin-top: 30px; justify-content: flex-start;">
                            <button class="btn btn-green" id="update-content-ok">确定</button>
                        </div>
                    `;
                    showModal(content);
                    
                    // 确定按钮事件
                    document.getElementById('update-content-ok').addEventListener('click', hideModal);
                });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            init();
            registerServiceWorker();
        });
    </script>
</body>
</html>